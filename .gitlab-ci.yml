image: kasproject/kas:2.0

variables:
  GIT_STRATEGY: clone
  GIT_DEPTH: 1

stages:
- build
- deploy
- test

build_bbb:
  stage: build
  script:
    - kas build --target core-image-minimal kas-bbb.yml
  artifacts:
    paths:
      - build/tmp/deploy/images

deploy_bbb:
  stage: deploy
  script:
    - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    - scripts/deploy.sh bbb
      build/tmp/deploy/images/beaglebone/zImage
      build/tmp/deploy/images/beaglebone/core-image-minimal-beaglebone.cpio.gz
      build/tmp/deploy/images/beaglebone/am335x-boneblack.dtb
  dependencies:
    - build_bbb
  only:
    - cip-core-buster

build_iwg20m:
  stage: build
  script:
    - kas build --target core-image-minimal kas-iwg20m.yml
  artifacts:
    paths:
      - build/tmp/deploy/images

deploy_iwg20m:
  stage: deploy
  script:
    - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    - scripts/deploy.sh iwg20m
      build/tmp/deploy/images/iwg20m/zImage
      build/tmp/deploy/images/iwg20m/core-image-minimal-iwg20m.tar.bz2
      build/tmp/deploy/images/iwg20m/r8a7743-iwg20d-q7.dtb
      build/tmp/deploy/images/iwg20m/r8a7743-iwg20d-q7-dbcm-ca.dtb
  dependencies:
    - build_iwg20m
  only:
    - cip-core-buster

build_hihope-rzg2m:
  stage: build
  script:
    - kas build --target core-image-minimal kas-hihope-rzg2m.yml
  artifacts:
    paths:
      - build/tmp/deploy/images

deploy_hihope-rzg2m:
  stage: deploy
  script:
    - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
    - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    - scripts/deploy.sh hihope-rzg2m
      build/tmp/deploy/images/hihope-rzg2m/Image
      build/tmp/deploy/images/hihope-rzg2m/core-image-minimal-hihope-rzg2m.tar.bz2
      build/tmp/deploy/images/hihope-rzg2m/r8a774a1-hihope-rzg2m.dtb
      build/tmp/deploy/images/hihope-rzg2m/r8a774a1-hihope-rzg2m-ex.dtb
  dependencies:
    - build_hihope-rzg2m
  only:
    - cip-core-buster

test_hihope-rzg2m:
  stage: test
  script:
    - lava/submit-job.sh lava/jobs/hihope-rzg2m-uname.yml
